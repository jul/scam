<%inherit file="base.mako"/>
<%block name="include_head">
<script>
$(document).ready(() => {
    already=false;
    comment_id = ${fo.get("id",[0])[0]} ?  ${fo.get("id",[0])[0]} : $("[name=id]").val()
    $("form").each((i,el) => {
        $(el).append("<input name=_action type=submit value=create action=" + el.action +" >")
        $(el).append("<input name=_action type=submit value=search >")
        $(el).append("<input name=_action type=submit action=" + el.action +" value=update > <input name=_action type=submit value=delete >")
        $(el).append("<input name=_action type=submit action=" + el.action +" value=load >")
        $(el).append("<input name=_action type=submit value=clear >")
    });
    $("[value=clear]").on("click",function(e) {
        e.preventDefault();
            $("input:not([type=submit],[type=file],[type=password]),select,textarea", $($(this).parent())).each((i,el) => {
                $(el).val("");
            })
    })
    keyup = () => { 
        $("#iframe").attr("src", "doc?id=" + $("[name=id]").val() + "&text=" + encodeURI($("textarea").val().replace(/#/g, "%23").replace(/%0D%0A/g,'<br>').replace(/%0A/g,'<br>').replace(/%0D/g,'<br>') ))
        $("textarea").on("keyup", function() {
            if(already) {
                clearTimeout(already)
            }
            already=setTimeout(keyup, 700)
        });
    }
    $("[value=load]").on("click",function(e) {
        $("textarea").val("")
        $("input:not([type=submit],[name=id],[name=user_id],[name=_redirect])").each((i, el) => { $(el).val("") }) 
        $.ajax({
            url: "comment",
            data : { "id" : comment_id, _action : "search" }
        }).done((msg) => {
            $("#comment").html(msg.result[0][0]["message"].replace(/\n/g,"<br>"))
        })

        $.ajax({
            url: $(this).attr("action"),
            data : { "id" : comment_id, _action : "search" }
        }).done((msg) => {
            $("input:not([type=submit],[type=file],[type=password],[name=_redirect]),select,textarea", $($(this).parent())).each((i,el) => {
                $(el).val(msg.result[0][0][$(el).attr("name")]);
            }) 
            $("[name=_redirect]").val("/text?id=" + $("[name=id]").val())
        })
        name="${fo["_DB"][0]}.annexe." + $("[name=id]").val();
        $("#annexe_name").html(name)
        $("embed").attr("src", name)
         if(already) {
            clearTimeout(already)
        }
        already=setTimeout(keyup, 700)

        e.preventDefault();
    })
    $("[name=id]").on("input", () => { 
        $.ajax(url="order").done((msg) => {
            order=msg["_text_order"][0]
            actual=comment_id
            _new=$("[name=id]").val()
            indexof=order.indexOf(comment_id * 1)
            diff = _new > comment_id ? 1 : -1;
            comment_id=order[indexof+diff]
            $("[value=load]").click()
        })

        setTimeout(keyup, 150)
    })
    $("[value=load]").click()
    $("[name=_redirect]").val("/text?id=" + $("[name=id]").val())

});
</script>
<style>
    .text { background:#117; color:white ! important; border-radius:.5em; }
    #comment { min-height:10em;overflow:auto }
    fieldset { position:absolute; left:3%; width:45% }
    iframe { position:absolute; margin-right:3em; width:45%;  }
</style>
</%block>


   <div id=comment >
   </div>
   <div>
   annexe : <span id=annexe_name > ${fo["_DB"][0]}.annexe.${fo.get("id", [1])[0]} </span> <br>
   <embed src='${fo["_DB"][0]}.annexe.${fo.get("id", [1])[0]}' height=10em >

   </div>
    <form action="/text" >

        <input type=hidden name="_redirect" value="" >

        <input type=number name=id value="${fo.get("id", [1])[0]}" >
        <input type=number name=book_order >
        <input type=hidden name=user_id value=${fo["_user_id"][0]}  >
        <input type=hidden name=comment_id value="" >
        <textarea name=text rows=20 cols=80 nullable=false ></textarea>
   </form>
   <iframe id=iframe width=50% height=100% style=right:0 src="/${fo["_DB"][0]}.${fo.get("id", [1])[0]}.html" >
   </iframe>
